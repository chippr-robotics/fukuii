# Bootnode Configuration for Fukuii
# ═══════════════════════════════════════════════════════════════════════════
# This configuration optimizes a Fukuii node to act as a bootnode/beacon node
# for the Ethereum Classic network. A bootnode focuses exclusively on peer
# discovery and connection brokering, helping new nodes join the network faster.
#
# Purpose:
# - Track and maintain connections to as many peers as possible
# - Share peer information to help network discovery
# - Enable faster synchronization for new nodes joining the network
# - Minimize resource usage by not syncing blockchain data
#
# Usage:
#   ./bin/fukuii -Dconfig.file=/path/to/bootnode.conf etc
#
# Resources Required:
# - CPU: 2 cores (minimal)
# - RAM: 2-4 GB
# - Disk: ~5 GB (no blockchain data)
# - Network: 50-100 Mbps (handles many peer connections)
#
# Based on:
# - ADR-011: RLPx Protocol Deviations and Peer Bootstrap Challenge
# - Operating Modes Runbook: Boot Node section
# - Peering Runbook: Best practices for peer management
# ═══════════════════════════════════════════════════════════════════════════

# Include base configuration
# This pulls in all default settings from app.conf (which includes base.conf)
include "app.conf"

fukuii {
  # ═══════════════════════════════════════════════════════════════════════════
  # BLOCKCHAIN SYNCHRONIZATION - DISABLED
  # ═══════════════════════════════════════════════════════════════════════════
  # Bootnodes do not need to sync blockchain data. Disabling sync reduces
  # resource usage and allows the node to focus entirely on peer discovery.
  
  sync {
    # Disable fast sync - bootnode doesn't sync blockchain at all
    do-fast-sync = false
    
    # Note: Even with fast sync disabled, the node will not attempt to sync
    # because it won't execute the blockchain download logic. The node focuses
    # on discovery and peer connection management only.
  }
  
  # ═══════════════════════════════════════════════════════════════════════════
  # PRUNING - MINIMAL CONFIGURATION
  # ═══════════════════════════════════════════════════════════════════════════
  # Since bootnode doesn't sync blockchain, pruning settings are not critical.
  # Keep basic pruning as a safety measure in case any data is stored.
  
  pruning {
    mode = "basic"
    history = 64
  }
  
  # ═══════════════════════════════════════════════════════════════════════════
  # NETWORK CONFIGURATION - OPTIMIZED FOR PEER DISCOVERY
  # ═══════════════════════════════════════════════════════════════════════════
  
  network {
    # ═══════════════════════════════════════════════════════════════════════
    # RPC ENDPOINTS - DISABLED
    # ═══════════════════════════════════════════════════════════════════════
    # Bootnodes typically don't serve RPC endpoints since they don't have
    # blockchain data. Disabling RPC reduces attack surface and resource usage.
    
    rpc {
      http {
        enabled = false
      }
      
      ipc {
        enabled = false
      }
    }
    
    # ═══════════════════════════════════════════════════════════════════════
    # PEER DISCOVERY - MAXIMIZED
    # ═══════════════════════════════════════════════════════════════════════
    # Aggressive discovery settings to find and maintain connections to as
    # many peers as possible, maximizing the bootnode's effectiveness.
    
    discovery {
      # Enable discovery (essential for bootnode operation)
      discovery-enabled = true
      
      # Reuse previously discovered nodes on restart
      # This helps maintain a large peer list across restarts
      reuse-known-nodes = true
      
      # Scan more frequently than default to discover peers faster
      # Default: 1 minute, Bootnode: 30 seconds
      scan-interval = 30.seconds
      
      # Increase Kademlia bucket size to track more peers
      # Default: 16, Bootnode: 64
      # Each bucket can hold more peers, increasing total peers tracked
      kademlia-bucket-size = 64
      
      # Higher concurrency for discovery operations
      # Default: 3, Bootnode: 5
      # More parallel lookup operations for faster peer discovery
      kademlia-alpha = 5
      
      # Discovery timeouts (keep defaults as they work well)
      request-timeout = 1.seconds
      kademlia-timeout = 2.seconds
      message-expiration = 1.minute
      max-clock-drift = 15.seconds
      
      # External address configuration
      # Uncomment and set if your bootnode has a static public IP or hostname
      # This helps other nodes connect to your bootnode more reliably
      # host = "bootnode.example.com"
      # host = "203.0.113.1"
      
      # Discovery port (default: 30303)
      # Keep default unless you need to run multiple bootnodes on same machine
      port = 30303
      
      # Listening interface for discovery protocol
      # "0.0.0.0" accepts connections on all network interfaces
      interface = "0.0.0.0"
      
      # Channel capacity for discovery messages
      # Default: 100, keep as is unless you see dropped messages
      channel-capacity = 100
    }
    
    # ═══════════════════════════════════════════════════════════════════════
    # PEER MANAGEMENT - HIGH CAPACITY
    # ═══════════════════════════════════════════════════════════════════════
    # Maximize peer connections to act as an effective hub for peer discovery.
    # These limits are significantly higher than standard nodes.
    
    peer {
      # Minimum outgoing peer connections
      # Default: 20, Bootnode: 100
      # Bootnode actively maintains many connections
      min-outgoing-peers = 100
      
      # Maximum outgoing peer connections
      # Default: 50, Bootnode: 500
      # Allow bootnode to connect to very large number of peers
      max-outgoing-peers = 500
      
      # Maximum incoming peer connections
      # Default: 30, Bootnode: 200
      # Accept many incoming connections from nodes seeking peers
      max-incoming-peers = 200
      
      # Maximum pending connections
      # Default: 20, Bootnode: 50
      # Higher limit to handle connection bursts
      max-pending-peers = 50
      
      # Connection retry settings (keep defaults - they work well)
      connect-retry-delay = 5.seconds
      connect-max-retries = 1
      
      # Peer pruning settings
      # Default: 10, Bootnode: 20
      # Prune more aggressively to free up slots for new peers
      prune-incoming-peers = 20
      
      # Minimum age before peers can be pruned
      # Default: 30 minutes, Bootnode: 15 minutes
      # Faster rotation helps discover more unique peers
      min-prune-age = 15.minutes
      
      # Node update intervals
      # Default: 5 seconds initial, 30 seconds interval
      # Keep defaults for stable operation
      update-nodes-initial-delay = 5.seconds
      update-nodes-interval = 30.seconds
      
      # Blacklist durations (keep defaults)
      short-blacklist-duration = 6.minutes
      long-blacklist-duration = 600.minutes
      
      # Peer statistics tracking
      # Track peer statistics for monitoring bootnode health
      stat-slot-duration = 10.minutes
      stat-slot-count = 72
      
      # Timeouts (keep defaults - they're well-tuned)
      wait-for-hello-timeout = 3.seconds
      wait-for-status-timeout = 30.seconds
      wait-for-chain-check-timeout = 15.seconds
      wait-for-handshake-timeout = 3.seconds
      wait-for-tcp-ack-timeout = 5.seconds
      disconnect-poison-pill-timeout = 5.seconds
      
      # Response limits - aligned with base.conf optimal settings
      # ETH protocol uses 2MB soft response limit (core-geth)
      max-blocks-headers-per-message = 192
      max-blocks-bodies-per-message = 50
      max-receipts-per-message = 256
      max-mpt-components-per-message = 200
    }
    
    # ═══════════════════════════════════════════════════════════════════════
    # KNOWN NODES PERSISTENCE - ENHANCED
    # ═══════════════════════════════════════════════════════════════════════
    # Persist discovered peers more frequently and in larger quantities
    # to maintain a comprehensive peer list across restarts.
    
    known-nodes {
      # Persist more frequently to minimize loss on crash/restart
      # Default: 20 seconds, Bootnode: 10 seconds
      persist-interval = 10.seconds
      
      # Store many more nodes than default
      # Default: 200, Bootnode: 2000
      # Large peer list is the core value of a bootnode
      max-persisted-nodes = 2000
    }
    
    # ═══════════════════════════════════════════════════════════════════════
    # P2P SERVER ADDRESS
    # ═══════════════════════════════════════════════════════════════════════
    # Configure P2P connection endpoint
    
    server-address {
      # Listen on all interfaces to accept connections from anywhere
      interface = "0.0.0.0"
      
      # P2P port (default: 9076)
      # Keep default unless running multiple nodes on same machine
      port = 9076
    }
    
    # ═══════════════════════════════════════════════════════════════════════
    # AUTOMATIC PORT FORWARDING
    # ═══════════════════════════════════════════════════════════════════════
    # Enable UPnP for automatic port forwarding if behind NAT
    # Helps bootnode become publicly accessible automatically
    
    automatic-port-forwarding = true
  }
  
  # ═══════════════════════════════════════════════════════════════════════════
  # SHUTDOWN TIMEOUT
  # ═══════════════════════════════════════════════════════════════════════════
  # Allow enough time for graceful shutdown to persist peer list
  
  shutdown-timeout = "30.seconds"
  
  # ═══════════════════════════════════════════════════════════════════════════
  # OPTIONAL: CLIENT IDENTITY
  # ═══════════════════════════════════════════════════════════════════════════
  # Optionally identify this node as a bootnode in Hello messages
  # Uncomment to customize:
  # client-identity = "Fukuii Bootnode"
}

# ═══════════════════════════════════════════════════════════════════════════
# OPERATIONAL NOTES
# ═══════════════════════════════════════════════════════════════════════════
#
# Getting Your Bootnode's Enode URL:
# -----------------------------------
# 1. Your node ID is derived from ~/.fukuii/<network>/node.key
# 2. Construct enode URL: enode://<node-id>@<public-ip>:30303
# 3. Share this URL with others who want to use your bootnode
#
# Firewall Configuration:
# -----------------------
# Ensure these ports are open:
# - UDP 30303 (discovery protocol) - REQUIRED
# - TCP 9076 (P2P connections) - REQUIRED
#
# Example firewall rules:
#   sudo ufw allow 30303/udp
#   sudo ufw allow 9076/tcp
#
# Monitoring Your Bootnode:
# -------------------------
# Check logs for peer activity:
#   tail -f ~/.fukuii/etc/logs/fukuii.log | grep -E "peer|discovery"
#
# Look for messages indicating healthy operation:
#   - "Discovery - Found N peers in routing table"
#   - "PeerManager - Connected to peer"
#   - Regular discovery activity
#
# Bootnode Best Practices:
# ------------------------
# 1. Use a static public IP or reliable hostname
# 2. Ensure high uptime (bootnodes should be always available)
# 3. Monitor disk space for knownNodes.json growth
# 4. Monitor network bandwidth (many connections = higher traffic)
# 5. Set up alerting if peer count drops below threshold
# 6. Consider running multiple bootnodes for redundancy
# 7. Keep the bootnode software updated
#
# Network Topology Considerations:
# --------------------------------
# - Bootnodes are critical infrastructure for network health
# - They should be distributed geographically for best coverage
# - Consider running on reliable infrastructure (VPS, cloud, dedicated server)
# - Avoid running bootnode on residential connections (potential ISP issues)
#
# Security Considerations:
# ------------------------
# - Bootnodes are exposed to the public internet
# - Disable RPC endpoints (already done in this config)
# - Monitor for abuse (DDoS attempts, connection spam)
# - Consider rate limiting at firewall level if needed
# - Keep system and Fukuii updated with security patches
#
# Resource Monitoring:
# --------------------
# Monitor these metrics:
# - Peer count (should be consistently high, 200-500+)
# - Network bandwidth usage (will be higher than regular nodes)
# - CPU usage (should be low, <20%)
# - Memory usage (should be stable, 2-4 GB)
# - Disk space for knownNodes.json (~100-500 MB)
#
# Troubleshooting:
# ----------------
# If peer count is low:
# 1. Verify ports are open (use online port checker)
# 2. Check firewall rules
# 3. Verify public IP/hostname is correct if set
# 4. Check logs for connection errors
# 5. Ensure automatic-port-forwarding is working or manually forward ports
#
# If seeing connection errors:
# 1. Check if clock is synchronized (NTP)
# 2. Verify network connectivity
# 3. Check for rate limiting by ISP
# 4. Review logs for specific error patterns
#
# For more information:
# ---------------------
# - Operating Modes Runbook: docs/runbooks/operating-modes.md
# - Peering Runbook: docs/runbooks/peering.md
# - ADR-011: docs/adr/011-rlpx-protocol-deviations-and-peer-bootstrap.md
# ═══════════════════════════════════════════════════════════════════════════
