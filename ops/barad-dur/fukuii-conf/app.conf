# Fukuii Configuration for Barad-d√ªr (Kong API Gateway) Setup
# This configuration optimizes Fukuii to work behind Kong's load balancer

include "base.conf"

fukuii {
  # Network selection (etc, eth, mordor)
  blockchains.network = "etc"

  # Data directory
  datadir = "/app/data"

  network {
    # Server address for P2P connections
    server-address {
      # Listen on all interfaces
      interface = "0.0.0.0"
      port = 9076
    }

    # RPC configuration - Kong will proxy to these endpoints
    rpc {
      http {
        # Enable HTTP JSON-RPC
        enabled = true
        
        # Listen on all interfaces (Kong proxies to this)
        interface = "0.0.0.0"
        port = 8546
        
        # CORS is handled by Kong, so we can disable it here
        cors-allowed-origins = []
        
        # Rate limiting is handled by Kong
        rate-limit {
          enabled = false
        }
      }

      # IPC endpoint (optional)
      ipc {
        enabled = false
      }

      # Enable all APIs - Kong will manage access control
      apis = "eth,web3,net,personal,fukuii,debug,qa,checkpointing"
    }

    # Discovery configuration
    discovery {
      discovery-enabled = true
      interface = "0.0.0.0"
      port = 30303
      reuse-known-nodes = true
    }
  }

  # Metrics for Prometheus
  metrics {
    enabled = true
    port = 9095
  }

  # Sync configuration
  sync {
    # Optimize for fast sync
    do-fast-sync = true
    
    # Check for new blocks frequently
    check-for-new-block-interval = 10.seconds
    
    # Download multiple blocks in parallel
    block-headers-per-request = 128
    block-bodies-per-request = 128
    receipts-per-request = 60
    nodes-per-request = 200
    
    # Maximum concurrent requests
    max-concurrent-requests = 50
    
    # Pivot block for fast sync (set to 0 to disable)
    pivot-block-offset = 256
  }

  # Transaction pool
  txPool {
    tx-pool-size = 4096
    pending-tx-manager-query-timeout = 30.seconds
    transaction-timeout = 5.minutes
  }

  # Database configuration
  db {
    # RocksDB configuration
    rocks-db {
      create-if-missing = true
      paranoid-checks = true
      
      # Memory settings
      block-cache-size = 512000000
      
      # Compression
      compression = "lz4"
      
      # Write buffer
      write-buffer-size = 67108864
      max-write-buffer-number = 3
      
      # Read ahead
      use-direct-reads = true
      
      # WAL configuration
      wal-dir = null
      max-total-wal-size = 0
    }
  }

  # Pruning configuration (for production nodes)
  pruning {
    # Enable pruning to save disk space
    mode = "archive"  # Options: archive, basic, insecure
    
    # History blocks to keep (only for basic mode)
    # history = 128
  }

  # Logging
  logging {
    # Log level
    logs-level = "INFO"
    
    # JSON structured logging (better for log aggregation)
    json-output = true
    
    # Log file (or use stdout with Kong)
    logs-file = null  # null means stdout
  }
}

# Pekko (Actor system) configuration
pekko {
  loglevel = "INFO"
  stdout-loglevel = "INFO"
  
  loggers = ["org.apache.pekko.event.slf4j.Slf4jLogger"]
  logging-filter = "org.apache.pekko.event.slf4j.Slf4jLoggingFilter"
  
  actor {
    default-dispatcher {
      type = "Dispatcher"
      executor = "fork-join-executor"
      
      fork-join-executor {
        parallelism-min = 2
        parallelism-factor = 2.0
        parallelism-max = 16
      }
      
      throughput = 100
    }
  }
}
