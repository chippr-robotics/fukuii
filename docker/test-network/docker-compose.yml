version: '3.8'

networks:
  test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  core-geth-data:
  fukuii-data:
  fukuii-logs:

services:
  # Core-geth node - Ethereum Classic client
  core-geth:
    image: etclabscore/core-geth:latest
    container_name: test-core-geth
    networks:
      test-network:
        ipv4_address: 172.25.0.10
    ports:
      - "8545:8545"   # HTTP RPC
      - "8546:8546"   # WebSocket RPC
      - "30303:30303" # P2P
    volumes:
      - core-geth-data:/root/.ethereum
    command: >
      --classic
      --http
      --http.addr=0.0.0.0
      --http.port=8545
      --http.api=eth,net,web3,personal
      --ws
      --ws.addr=0.0.0.0
      --ws.port=8546
      --ws.api=eth,net,web3
      --networkid=61
      --port=30303
      --nat=extip:172.25.0.10
      --verbosity=4
      --maxpeers=50
      --nodiscover=false
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "geth attach --exec 'eth.blockNumber' http://localhost:8545 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Fukuii node - Our Ethereum Classic client
  fukuii:
    image: chipprbots/fukuii:latest
    container_name: test-fukuii
    networks:
      test-network:
        ipv4_address: 172.25.0.20
    ports:
      - "8547:8546"   # HTTP RPC (mapped to 8547 to avoid conflict)
      - "8548:8547"   # WebSocket RPC (mapped to 8548 to avoid conflict)
      - "30304:30303" # P2P (mapped to 30304 to avoid conflict)
    volumes:
      - fukuii-data:/app/data
      - fukuii-logs:/app/logs
      - ./fukuii.conf:/app/conf/application.conf:ro
    environment:
      - JAVA_OPTS=-Xmx2g -Xms2g
      - FUKUII_NETWORK=etc
    depends_on:
      core-geth:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["/usr/local/bin/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Log collector service to capture and display logs
  log-collector:
    image: ubuntu:22.04
    container_name: test-log-collector
    networks:
      - test-network
    volumes:
      - fukuii-logs:/logs:ro
      - ./collect-logs.sh:/collect-logs.sh:ro
    depends_on:
      - fukuii
      - core-geth
    command: tail -f /dev/null
    restart: unless-stopped
